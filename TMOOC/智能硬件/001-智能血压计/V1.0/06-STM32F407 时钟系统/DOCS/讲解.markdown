

# STM32F407 时钟系统 #
- 课程简介
- 【讲解】STM32F407时钟系统
- 【案例】系统初始化时钟代码分析 
- 【案例】修改系统主频的方法
- 【讲解】RCC 相关库函数介绍

嵌入式硬件系统的时钟系统就像人的心脏一样，周期性跳动，保证整个系统的稳定、有效的运行。我们通常说的主频就是和硬件的时钟系统息息相关的。

STM32F407有一个完备、且强大的时钟系统，其最高可提供168Mhz的CPU主频。



## STM32F407时钟系统 ##

### STM32F407时钟系统概述 ###

- 有高速时钟和低速次级时钟
	- 4-26M时钟源 (最高可提供168M)
	- 32768hz时钟源
- 芯片内部集成了高速、低速振荡器
- 每个时钟源可以单独开启和关闭
- 

### 时钟源 ###
- 高速（HSI 16MHz，HSE 4-26MHz)
	+ HSI RC  16MHz
		* 成本低，精度不佳，出厂校准，25度，1%精度
		* 复位后，工厂校准值将加载到 RCC 时钟控制寄存器 (RCC_CR) 的HSICAL[7:0] 位中。
		* 如果应用受到电压或温度变化影响，则这可能也会影响到 RC振荡器的速度。用户可通过RCC 时钟控制寄存器 (RCC_CR) 中的HSITRIM[4:0] 位对 HSI 频率进行微调。
		* RCC 时钟控制寄存器 (RCC_CR) 中的 HSIRDY 标志指示 HSI RC是否稳定。在启动时，硬件将此位置 1 后， HSI 才可以使用。
		* HSI RC 可通过 RCC 时钟控制寄存器 (RCC_CR) 中的 HSION位打开或关闭
		* HSI 信号还可作为备份时钟源（辅助时钟）使用，以防 HSE晶振发生故障。
		* 

	+ HSE 晶振 4-26MHz（含接法）
		* OSC_OUT，OSC_IN  
		* OSC_IN 占空比50%（方波、正玄波、三角波），OSC_OUT高阻态
		* RCC 时钟控制寄存器 (RCC_CR) 中的 HSERDY 志指示高速外部振荡器是否稳定。在启动时，硬件将此位置 1 后，此时钟才可以使用。如在 RCC 时钟中断寄存器 (RCC_CIR) 中使能中断，则可产生中断。
		* HSE 晶振可通过 RCC 时钟控制寄存器 (RCC_CR) 中的 HSEON位打开或关闭。

- 低速
	+ LSI RC 32kHz
	+ LSE 晶振 32768Hz
		* OSC32_IN,OSC32_OUT
	
- 特殊
	+ I2S_CKIN i2s时钟
	+ 以太网（PHY提供的时钟 25-50M Hz）
	+ USB 2.0 PHY 提供 24-60M Hz

### PLL锁相环 ###
- 主PLL
	+ 由 HSE或者HSI提供时钟信号，就有两个不同的时钟输出
	+ 第一个输出最高168MHz
	+ 第二个输出用于USB OTG FS的时钟（48MHz），随机数发生器时钟（小于等于48MHz)，SDIO时钟（小于等于48MHz）
- 专用PLL
	+ PLLI2S用于生高精度时钟，以便能提供高音质音频性能。
		* PLLI2S 使用与 PLL 相同的输入时钟（ PLLM[5:0] 和 PLLSRC 位为两个 PLL 所共用）。但是， PLLI2S 具有专门的使能/禁止和分频系数（ N 和 R）配置位。在 PLLI2S 使能后，配置参数便不能更改。


- 由于在 PLL 使能后主 PLL 配置参数便不可更改，所以建议先对 PLL 进行配置，然后再使能
（选择 HSI 或 HSE 振荡器作为 PLL 时钟源，并配置分频系数 M、 N、 P 和 Q）。

- 当进入停机和待机模式后，两个 PLL 将由硬件禁止；

- 

### 时钟输出 ###

- MCO2
- MCO1


### SYSCLK ###
- 最高168M Hz
- 产生与配置
- 作用，除
	+ 来自于特定PLL输出（PLL48CLK）的USB OTG FS时钟（48M Hz）、
	  基于模拟技术的随机数发生器（RNG）时钟（小于等于48M Hz）、
	  SDIO时钟（小于等于48M Hz）
	+ I2S时钟，要实现高品质的音频性能，可通过特定的 PLL (PLLI2S) 映射到 I2S_CKIN 引脚的外部时钟提供 I2S 时钟。
	+ 由外部 PHY 提供的 USB OTG HS (60 MHz) 时钟。
	+ 由外部 PHY 提供的以太网 MAC 时钟（ TX、 RX 和 RMII），当使用以太网时， AHB时钟频率至少应为 25 MHz。	+ 
- SYSCLK产生过程，以8Mhz晶振为例
	+ 上电默认使用HSI作为时钟源
	+ 要使用外部的 8MHz的晶振作为时钟源，产生168 MHz的 SYSCLK，配置过程如下：
		* 


